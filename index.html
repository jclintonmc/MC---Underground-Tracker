<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  deleteDoc,
  doc,
  query,
  orderBy,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyChNb8zTdAPahDCgTah1W0CRpMS7S9wpI8",
  authDomain: "mc-underground-tracker.firebaseapp.com",
  projectId: "mc-underground-tracker",
  storageBucket: "mc-underground-tracker.firebasestorage.app",
  messagingSenderId: "214694975194",
  appId: "1:214694975194:web:de814a7e23074faa37b7e3"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = collection(db, "entries");

/* ================= STATE ================= */
let data = [];

/* ================= INIT ================= */
date.value = new Date().toISOString().split("T")[0];

/* ================= REAL-TIME LISTENER ================= */
onSnapshot(query(ref, orderBy("date", "asc")), snap => {
  data = snap.docs.map(d => ({
    id: d.id,
    ...d.data()
  }));
  render();
});

/* ================= SAVE ================= */
window.save = async () => {
  let d = +dig.value || 0;
  let l = +lay.value || 0;
  let b = +back.value || 0;
  let t = +test.value || 0;

  let total = d + l + b + t;
  let wip = total;

  await addDoc(ref, {
    date: date.value,
    project: project.value,
    crew: crew.value || "",
    cost: cost.value || "",
    dig: d,
    lay: l,
    back: b,
    test: t,
    total,
    wip,
    created: Date.now()
  });

  dig.value = lay.value = back.value = test.value = "";
};

/* ================= DELETE ================= */
window.del = async i => {
  const entry = data[i];
  if (!entry) return;
  if (!confirm("Delete entry?")) return;
  await deleteDoc(doc(db, "entries", entry.id));
};

/* ================= RENDER ================= */
function render() {
  log.innerHTML = "";
  let td = 0, tl = 0, tb = 0, tt = 0, tp = 0, tw = 0;

  data.forEach((e, i) => {
    td += e.dig;
    tl += e.lay;
    tb += e.back;
    tt += e.test || 0;
    tp += e.total;
    tw += e.wip;

    log.innerHTML += `
      <tr>
        <td>${e.date}</td>
        <td>${e.project}</td>
        <td>${e.crew}</td>
        <td>${e.cost}</td>
        <td>${e.dig}</td>
        <td>${e.lay}</td>
        <td>${e.back}</td>
        <td>${e.test || 0}</td>
        <td>${e.total}</td>
        <td>${e.wip.toFixed(2)}</td>
        <td><button class="del" onclick="del(${i})">X</button></td>
      </tr>
    `;
  });

  kDig.textContent = td;
  kLay.textContent = tl;
  kBack.textContent = tb;
  kPhys.textContent = tp;
  kWip.textContent = tw.toFixed(2);
}
</script>
